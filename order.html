<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order — YourBracelet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Poppins, sans-serif;background:#f6f7fb;color:#111;margin:0;padding:20px;}
    .card{max-width:900px;margin:18px auto;background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,0.06)}
    h2{margin-bottom:8px}
    label{display:block;margin-top:10px;color:#4b5563;font-size:13px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:#fbfbfd;font-size:14px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .btn{display:inline-block;padding:10px 14px;border-radius:999px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#ec4899,#f97316);color:#fff}
    .note{color:#6b7280;font-size:13px;margin-top:10px}
    .preview{display:flex;gap:12px;align-items:center;margin-top:12px}
    .preview img{max-width:160px;border-radius:10px;border:1px solid #e5e7eb;object-fit:cover;height:120px}
    .preview .placeholder{width:160px;height:120px;border-radius:10px;border:1px dashed #e5e7eb;display:flex;align-items:center;justify-content:center;color:#9ca3af;background:#fff;text-align:center;padding:8px}
    .preview .open-video{display:block;margin-top:6px;font-size:13px;color:#ec4899;text-decoration:underline;cursor:pointer}
    .small-muted{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h2>Order Form — YourBracelet</h2>
    <div id="sourceShow" class="note">Source: —</div>

    <div class="preview" id="imgPreview" style="display:none">
      <img id="previewImg" src="" alt="Preview">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div class="note" id="imgLabel"></div>
        <a id="openVideoLink" class="open-video" style="display:none" target="_blank" rel="noopener">Open video</a>
      </div>
    </div>

    <!-- Order form (same fields as main page) -->
    <form id="orderForm">
      <label>पूरा नाम*</label>
      <input id="name" required placeholder="जैसे — रोहन सोलंकी" />

      <label>मोबाइल नंबर (WhatsApp)*</label>
      <input id="phone" required placeholder="10 digit" maxlength="10" />

      <div class="row">
        <div class="col">
          <label>शहर*</label>
          <input id="city" required />
        </div>
        <div class="col">
          <label>स्टेट*</label>
          <input id="state" required />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>पिनकोड*</label>
          <input id="pincode" required maxlength="6" />
        </div>
        <div class="col">
          <label>क्वांटिटी*</label>
          <input id="quantity" type="number" value="1" min="1" />
        </div>
      </div>

      <label>पूरा पता*</label>
      <textarea id="address" required></textarea>

      <label>Extra Note (optional)</label>
      <textarea id="note"></textarea>

      <!-- Hidden field to store clicked source -->
      <input type="hidden" id="clickedSource" name="clickedSource" value="Direct / Not selected">

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button type="button" id="payBtn" class="btn btn-primary">1️⃣ Proceed to Payment (QR नीचे)</button>
        <button type="button" id="sendWA" class="btn" style="border:1px solid #ec4899;color:#ec4899">2️⃣ I Paid — Send WhatsApp</button>
      </div>

      <p class="note">नोट: नीचे QR स्कैन करके Booking Charges (₹500) भेजें और स्क्रीनशॉट सेव रखें।</p>

      <div style="margin-top:12px">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:180px;border-radius:12px;border:2px dashed #ec4899;padding:8px;text-align:center;background:#fff">
            <img src="qr.jpg" alt="QR" style="max-width:100%">
          </div>
          <div class="note">
            <strong>UPI ID:</strong> yourupi@bank<br>
            <strong>Amount:</strong> ₹500 (Booking)
          </div>
        </div>
      </div>
    </form>
  </div>

<script>
  // read query params
  const params = new URLSearchParams(location.search);
  const product = params.get('product') || 'Direct / Not selected';
  const imgParamRaw = params.get('img') || '';

  // Elements
  const previewContainer = document.getElementById('imgPreview');
  const previewImg = document.getElementById('previewImg');
  const imgLabel = document.getElementById('imgLabel');
  const openVideoLink = document.getElementById('openVideoLink');
  const clickedSourceInput = document.getElementById('clickedSource');

  // add a visible file input for gallery upload at top (above form fields)
  (function addFileInput() {
    const form = document.getElementById('orderForm');
    const wrapper = document.createElement('div');
    wrapper.style.marginTop = '12px';
    wrapper.innerHTML = `
      <label>अपनी फोटो अपलोड करें (गैलरी चुनें):</label>
      <input id="fileInput" type="file" accept="image/*" style="padding:8px;background:#fff;border-radius:8px" />
      <div class="small-muted">क्लियर फोटो चुनें। फोटो चुनते ही यहाँ प्रीव्यू दिखाई देगा। (WhatsApp पर फ़ाइल मैन्युअल attach करें)</div>
    `;
    form.insertBefore(wrapper, form.firstChild);
    initFileHandlers();
  })();

  // helper: detect video URL by extension or mp4 string
  function isVideoUrl(url) {
    if (!url) return false;
    try {
      const u = url.split('?')[0].toLowerCase();
      return /\.(mp4|webm|ogg)$/i.test(u) || u.includes('.mp4') || u.includes('.webm');
    } catch (e) {
      return false;
    }
  }

  // show preview from a remote URL (image) or show video placeholder/open link if video
  function showPreviewFromURL(url, labelText) {
    if (!url) return;
    // normalize
    let finalUrl = url;
    try { finalUrl = decodeURIComponent(url); } catch (e) { finalUrl = url; }

    if (isVideoUrl(finalUrl)) {
      // video -> show placeholder and open-video link
      previewImg.style.display = 'none';
      previewContainer.style.display = 'flex';
      imgLabel.textContent = (labelText || 'Video') + ' (video)';
      openVideoLink.style.display = 'inline-block';
      openVideoLink.href = finalUrl;
      openVideoLink.textContent = 'Open video';
      clickedSourceInput.value = (labelText || 'Video') + ' | ' + finalUrl;
    } else {
      // image -> set src, hide openVideoLink
      openVideoLink.style.display = 'none';
      previewImg.style.display = '';
      previewImg.src = finalUrl;
      previewImg.onload = () => {
        previewContainer.style.display = 'flex';
        imgLabel.textContent = labelText || 'Selected Photo';
      };
      previewImg.onerror = () => {
        // if image fails, show placeholder text
        previewImg.style.display = 'none';
        previewContainer.style.display = 'flex';
        imgLabel.textContent = (labelText || 'Selected Photo') + ' (image failed to load)';
        openVideoLink.style.display = 'none';
      };
      clickedSourceInput.value = (labelText || '') + ' | ' + finalUrl;
    }
  }

  // initialize file input & click-to-open picker
  function initFileHandlers() {
    const fileInput = document.getElementById('fileInput');

    // if query param img present, show as preview
    if (imgParamRaw) {
      showPreviewFromURL(imgParamRaw, product);
    }

    // click preview container opens file picker
    previewContainer.addEventListener('click', () => {
      if (fileInput) fileInput.click();
    });

    // when user picks file from gallery
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        alert('कृपया केवल इमेज फ़ाइल चुनें।');
        fileInput.value = '';
        return;
      }
      // objectURL preview
      const objectUrl = URL.createObjectURL(file);
      openVideoLink.style.display = 'none';
      previewImg.style.display = '';
      previewImg.src = objectUrl;
      previewImg.onload = () => {
        previewContainer.style.display = 'flex';
        imgLabel.textContent = file.name || 'Selected Photo';
        clickedSourceInput.value = 'Uploaded from gallery | ' + (file.name || 'selected-image');
        // revoke later
        setTimeout(() => URL.revokeObjectURL(objectUrl), 5000);
      };
      previewImg.onerror = () => {
        previewImg.style.display = 'none';
        previewContainer.style.display = 'flex';
        imgLabel.textContent = (file.name || 'Selected Photo') + ' (preview failed)';
      };
    });
  }

  // show source text
  document.getElementById('sourceShow').textContent = 'Source: ' + product;

  function getFormData() {
    return {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      city: document.getElementById('city').value.trim(),
      state: document.getElementById('state').value.trim(),
      pincode: document.getElementById('pincode').value.trim(),
      quantity: document.getElementById('quantity').value,
      address: document.getElementById('address').value.trim(),
      note: document.getElementById('note').value.trim(),
      clickedFrom: document.getElementById('clickedSource').value
    };
  }

  function validate() {
    const f = getFormData();
    if (!f.name || !f.phone || !f.city || !f.state || !f.pincode || !f.address) {
      alert('कृपया सभी required फील्ड्स भरें।'); return false;
    }
    if (f.phone.length !== 10) { alert('कृपया 10 digit फोन नंबर डालें।'); return false; }
    if (f.pincode.length !== 6) { alert('6 digit पिनकोड भरें।'); return false; }
    return true;
  }

  // pay button scroll
  const payBtn = document.getElementById('payBtn');
  payBtn.addEventListener('click', () => {
    if (!validate()) return;
    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
  });

  // WhatsApp button — app fallback then web
  const whatsappBtn = document.getElementById('sendWA');
  whatsappBtn.addEventListener('click', () => {
    if (!validate()) return;
    const f = getFormData();
    const message =
      "*New Bracelet Order*\n\n" +
      "Name: " + f.name + "\n" +
      "Phone: " + f.phone + "\n" +
      "City/State: " + f.city + " / " + f.state + "\n" +
      "Pincode: " + f.pincode + "\n" +
      "Qty: " + f.quantity + "\n" +
      "Address: " + f.address + "\n" +
      "Note: " + (f.note || "-") + "\n" +
      "Clicked From / Photo Source: " + (f.clickedFrom || "Direct") + "\n\n" +
      "Payment: Booking Charges ₹500 (QR से भेजा / भेजूँगा). स्क्रीनशॉट attach करके भेज रहा/करूँगा.";

    const encoded = encodeURIComponent(message);
    const whatsappNumber = "916376662787"; // use 91XXXXXXXXXX
    const appUrl = "whatsapp://send?phone=" + whatsappNumber + "&text=" + encoded;
    const webUrl = "https://api.whatsapp.com/send?phone=" + whatsappNumber + "&text=" + encoded;

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobile) {
      // try app first, then fallback to web after short timeout
      window.location.href = appUrl;
      setTimeout(() => { window.location.href = webUrl; }, 1200);
    } else {
      // desktop -> open web in new tab
      window.open(webUrl, "_blank");
    }
  });
</script>
</body>
</html>
